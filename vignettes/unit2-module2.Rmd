---
title: "unit2-module2"
author: "Harrison Leduc"
date: "2024-03-30"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{unit2-module2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(hjl246)
```

DOUBLE CHECK WHICH OF THESE NEED TO BE LOADED IN ##################
##############eERROR##########################################
Data
```{r}
library(geospaar)
chirps <- rast(system.file("extdata/chirps.tif", package = "geospaar"))
districts <- system.file("extdata/districts.geojson", package = "geospaar") %>%   st_read %>% mutate(ID = 1:nrow(.))
chirpsz <- mask(x = chirps, mask = districts)

farmers <- system.file("extdata/farmer_spatial.csv", package = "geospaar") %>%     read_csv(show_col_types = FALSE) 
roads <- system.file("extdata/roads.geojson", package = "geospaar") %>% st_read


```

Task 1
```{r}

districts_ss <- districts[c(22, 26, 53, 54), ]
districts_ss
  
r <- rast(x = ext(districts_ss), crs = crs(districts), resolution = 0.1)
r

set.seed(1)
rsamp <- r
values(rsamp) <- sample(10:50, size = ncell(rsamp), replace = TRUE)
rsamp

rrandn <- r
values(rrandn) <- rnorm(n = ncell(rrandn), mean = 30, sd = 5)
rrandn

#s <- stack(rsamp, rrandn)
#s <- stack(rsamp, rrandn) %>% 
#  mask(x = ., mask = districts_ss)
#s

s <- c(rsamp, rrandn) %>% 
  mask(x = ., mask = districts_ss)

plot_noaxes(s, axes = FALSE, mar = c(1, 0.5, 1, 4))
#s #????

#test_m <- mask(x = chirps[[1]], mask = districts)
#plot(test_m, axes = FALSE, mar = c(1, 0.5, 1, 4)) 

#plot_noaxes(s, axes = FALSE, mar = c(1, 0.5, 1, 4))  

```

Task 2
```{r}
s2_1d <- disagg(x = s[[1]], fact = 4, method = 'bilinear') 
s2_1d


s2_1gt35 <- s2_1d > 35
s2_1gt35

plot(s2_1gt35)
plot(app(s2_1gt35, sum))

  
#s2_1gt35 <- rast(x = s2_1gt35, resolution = 0.025, crs = crs(s2_1d))

s2_1gt35[s2_1gt35 == 0] <- NA

test3 <- as.points(x = s2_1gt35) %>% 
  st_as_sf


test <- s2_1gt35 > unlist(global(s2_1gt35, mean, na.rm = TRUE))


str(test)
plot(s2_1d, main = paste0("Disagg bilinear"))
plot(test, add = TRUE)


```

Task 3
```{r}
zamr <- rast(x = ext(districts), crs = crs(districts), resolution = 0.5)
zamr
values(zamr) <- 1
zamr


#farmers <- system.file("extdata/farmer_spatial.csv", package = "geospaar") %>%     read_csv(show_col_types = FALSE) 

farmersr <- farmers %>% 
  distinct(uuid, .keep_all = TRUE) %>% 
  dplyr::select(x, y) %>% 
  mutate(count = 1) %>% 
  st_as_sf(coords = c("x", "y"), crs = 4326) %>% 
  rasterize(x = ., y = zamr, field = "count", fun = sum) %>% 
  print()
farmersr

farmersr <- farmersr %>% 
  mask(x = ., mask = districts)


par(mar = c(0, 0, 1, 4))
districts %>% 
  st_union %>% 
  plot(col = "grey", border = "grey", 
       main = expression(paste("N farmers per 0.5", degree, " cell")))
plot(farmersr, add = TRUE, axes = FALSE)
```

Task 4
```{r}
farmersrpts <- as.points(x = farmersr) %>% 
  st_as_sf
farmersrpts

zamr <- rast(x = ext(zamr), crs = crs(zamr), resolution = 0.05)
zamr

dist_to_farmers <- distance(x = zamr, y = farmersrpts)
  
  
dist_to_farmers <- dist_to_farmers %>% 
  mask(x = ., mask = districts)


plot_noaxes(dist_to_farmers / 1000)
plot(farmersrpts, pch = 19, col = "black", add = TRUE)
```

Task 5


```{r}
wctemp <- geodata::worldclim_country(var = "tavg", res = 2.5, 
                                     country = "Zambia", path = tempdir())

zamtmean <- mask(app(wctemp, mean), districts)
zamtmean

plot(zamtmean, axes = FALSE, nr = 1, mar = c(1, 0.5, 1, 4))

```

Task 6
```{r}
trng <- global(zamtmean, range, na.rm = TRUE)
reclmat <- cbind(c(floor(trng[1]), 20, 24), c(20, 24, ceiling(trng[2])), 1:3)

zamtclass <- classify(x = zamtmean, rcl = unlist(reclmat), include.lowest = TRUE)

cols <- c("blue", "yellow2", "red")

plot_noaxes(zamtclass, legend = FALSE, main = "Average Temps", col = cols,
            mar = c(1, 1, 1, 3))
legend(x = "bottomright",
       col = cols, pch = 15, pt.cex = 3,  bty = "n",
       legend = c('Low', 'Medium', 'High'))
```

Ceiling and floor are rounding functions. To be specific...

(Formal definitions from the help page)
The floor function takes a single numeric argument and gives a numeric vector
containing the largest integers not greater than the initial single single
numeric argument.

The ceiling function takes a single numeric argument and gives a numeric
vector that holds the smallest integers that aren't less than the initial 
single numeric argument.

(Simple summary)
Floor gives the largest integer that isn't greater than the input. While 
ceiling gives the smallest integer that isn't less than the input.

Task 7
```{r}
wcprec <- geodata::worldclim_country(var = "prec", res = 2.5, 
                                     country = "Zambia", path = tempdir())
zamprec <- mask(app(wcprec, mean), districts)

zamprec_rs <- resample(x = zamprec, y = zamtclass, method = "near")  # match extent
z <- zonal(x = zamprec_rs, z = zamtclass, fun = "mean")

subsz <- z %>% dplyr::select(1:2)
subsz

zamprecz <- subst(x = zamtclass, from = subsz[, 1], to = subsz[, 2])
zamprecz

cols <- c("yellow2", "green3", "blue")
plot_noaxes(zamprecz)

```

Recreate the zamprec dataset (chunk 48), then calculate the mean precipitation within each temperature zone defined by zamtclass. Call the resulting matrix z. Map the mean zonal precipitation values in z onto each temperature zone (using the subst function with zamtclass as the target; remember that zonal returns a matrix, and that subst requires equal length vector for the “from” and “to” values. Call the new raster zamprecz, and then plot it using plot_noaxes, with a custom legend (as done in Task 6), using the rounded zonal mean values (rounded) as the legend labels (legend = round(z$mean)). Use colors “yellow2”, “green3”, and “blue” for the three classes (Ref: Chunks 32, 33, 39)
