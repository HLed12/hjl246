---
title: "unit2-module2"
author: "Harrison Leduc"
date: "2024-03-30"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{unit2-module2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(hjl246)
```

DOUBLE CHECK WHICH OF THESE NEED TO BE LOADED IN ##################
##############eERROR##########################################
Data
```{r}
library(geospaar)
chirps <- rast(system.file("extdata/chirps.tif", package = "geospaar"))
districts <- system.file("extdata/districts.geojson", package = "geospaar") %>%   st_read %>% mutate(ID = 1:nrow(.))
chirpsz <- mask(x = chirps, mask = districts)

farmers <- system.file("extdata/farmer_spatial.csv", package = "geospaar") %>%     read_csv(show_col_types = FALSE) 
roads <- system.file("extdata/roads.geojson", package = "geospaar") %>% st_read


```

Task 1
```{r}

districts_ss <- districts[c(22, 26, 53, 54), ]
districts_ss
  
r <- rast(x = ext(districts_ss), crs = crs(districts), resolution = 0.1)
r

set.seed(1)
rsamp <- r
values(rsamp) <- sample(10:50, size = ncell(rsamp), replace = TRUE)
rsamp

rrandn <- r
values(rrandn) <- rnorm(n = ncell(rrandn), mean = 30, sd = 5)
rrandn

#s <- stack(rsamp, rrandn)
#s <- stack(rsamp, rrandn) %>% 
#  mask(x = ., mask = districts_ss)
#s

s <- c(rsamp, rrandn) %>% 
  mask(x = ., mask = districts_ss)

plot_noaxes(s, axes = FALSE, mar = c(1, 0.5, 1, 4))
#s #????

#test_m <- mask(x = chirps[[1]], mask = districts)
#plot(test_m, axes = FALSE, mar = c(1, 0.5, 1, 4)) 

#plot_noaxes(s, axes = FALSE, mar = c(1, 0.5, 1, 4))  

```

Task 2
```{r}
s2_1d <- disagg(x = s[[1]], fact = 4, method = 'bilinear') 
s2_1d


s2_1gt35 <- s2_1d > 35
s2_1gt35

plot(s2_1gt35)
plot(app(s2_1gt35, sum))

  
#s2_1gt35 <- rast(x = s2_1gt35, resolution = 0.025, crs = crs(s2_1d))

s2_1gt35[s2_1gt35 == 0] <- NA

test3 <- as.points(x = s2_1gt35) %>% 
  st_as_sf


test <- s2_1gt35 > unlist(global(s2_1gt35, mean, na.rm = TRUE))


str(test)
plot(s2_1d, main = paste0("Disagg bilinear"))
plot(test, add = TRUE)


```

Task 3
```{r}
zamr <- rast(x = ext(districts), crs = crs(districts), resolution = 0.5)
zamr
values(zamr) <- 1
zamr


#farmers <- system.file("extdata/farmer_spatial.csv", package = "geospaar") %>%     read_csv(show_col_types = FALSE) 

farmersr <- farmers %>% 
  distinct(uuid, .keep_all = TRUE) %>% 
  dplyr::select(x, y) %>% 
  mutate(count = 1) %>% 
  st_as_sf(coords = c("x", "y"), crs = 4326) %>% 
  rasterize(x = ., y = zamr, field = "count", fun = sum) %>% 
  print()
farmersr

farmersr <- farmersr %>% 
  mask(x = ., mask = districts)


par(mar = c(0, 0, 1, 4))
districts %>% 
  st_union %>% 
  plot(col = "grey", border = "grey", 
       main = expression(paste("N farmers per 0.5", degree, " cell")))
plot(farmersr, add = TRUE, axes = FALSE)
```

Task 4
```{r}
farmersrpts <- as.points(x = farmersr) %>% 
  st_as_sf
farmersrpts

zamr <- rast(x = ext(zamr), crs = crs(zamr), resolution = 0.05)
zamr

dist_to_farmers <- distance(x = zamr, y = farmersrpts)
  
  
dist_to_farmers <- dist_to_farmers %>% 
  mask(x = ., mask = districts)


plot_noaxes(dist_to_farmers / 1000)
plot(farmersrpts, pch = 19, col = "black", add = TRUE)
```

Task 5

Use geodata’s worldclim_country function to grab WorldClim’s mean temperature (“tavg”) dataset at a resolution of 2.5 (note this is not degrees, but minutes of a degree), and download it to somewhere on your local disk. That will give a SpatRaster with 12 layers, with each layer representing the average monthly temperature for each grid cell on the planet. Calculate the annual mean temperature for each cell, and then mask the result using districts to get your final raster, zamtmean. Plot the result. (Ref: Chunk 17, 48)
```{r}
### chunk 17
chirpsz <- mask(x = chirps, mask = districts)

set.seed(1)
ind <- sample(1:nlyr(chirpsz), size = 3)
plot(chirpsz[[ind]], axes = FALSE, nr = 1, mar = c(1, 0.5, 1, 4))

### chunnk 48
wcprec <- geodata::worldclim_country(var = "prec", res = 2.5, 
                                     country = "Zambia", path = tempdir())
zamprec <- mask(app(wcprec, sum), districts)
```
